<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Canlƒ± Mesajlar - DM</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0f172a;
      --sidebar-bg: #1e293b;
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-gold: #f59e0b;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
    }

    body {
      margin: 0;
      background: var(--bg-dark);
      font-family: 'Inter', sans-serif;
      color: var(--text-main);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Scrollbar G√ºzelle≈ütirme */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }

    .dm-container {
      display: flex;
      flex: 1;
      height: calc(100vh - 48px);
      margin-top: 48px;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      border-right: 1px solid rgba(255,255,255,0.05);
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 24px 20px;
      font-size: 1.1rem;
      font-weight: 800;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: var(--accent-blue);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      margin: 4px 12px;
      cursor: pointer;
      border-radius: 12px;
      transition: all 0.2s ease;
    }

    .user-item:hover { background: rgba(255,255,255,0.05); }
    .user-item.active { background: var(--accent-blue); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

    .user-status {
      width: 10px; height: 10px; border-radius: 50%;
      border: 2px solid var(--sidebar-bg);
    }
    .user-status.online { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
    .user-status.offline { background: #64748b; }

    /* Main Chat Area */
    .main-dm-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0b0f1a;
    }

    .topbar {
      width: 100%;
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      position: fixed;
      top: 0; z-index: 100;
      height: 56px;
      display: flex; align-items: center; justify-content: flex-end;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .profile-name {
      font-weight: 600; padding: 6px 14px; border-radius: 20px;
      background: rgba(59, 130, 246, 0.1); color: var(--accent-blue);
    }

    .logout-btn {
      background: #ef4444; color: white; border: none;
      padding: 7px 16px; border-radius: 8px; font-weight: 600;
      margin: 0 20px 0 10px; cursor: pointer; transition: 0.2s;
    }
    .logout-btn:hover { background: #dc2626; transform: translateY(-1px); }

    .dm-header {
      padding: 0 25px;
      background: rgba(15, 23, 42, 0.5);
      font-size: 1.1rem; font-weight: 700;
      height: 60px; display: flex; align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .dm-messages {
      flex: 1; overflow-y: auto; padding: 25px;
      display: flex; flex-direction: column; gap: 14px;
    }

    .dm-msg {
      max-width: 65%; padding: 12px 16px; border-radius: 18px;
      font-size: 0.95rem; line-height: 1.4;
      background: #1e293b; color: #e2e8f0;
      align-self: flex-start; border-bottom-left-radius: 4px;
      animation: fadeIn 0.3s ease;
    }

    .dm-msg.me {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white; align-self: flex-end;
      border-bottom-left-radius: 18px; border-bottom-right-radius: 4px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dm-footer {
      padding: 20px; background: #0f172a;
      display: flex; gap: 12px; align-items: center;
    }

    #dmInput {
      flex: 1; background: #1e293b; border: 1px solid #334155;
      padding: 12px 18px; border-radius: 25px; color: white;
      outline: none; transition: 0.2s;
    }
    #dmInput:focus { border-color: var(--accent-blue); background: #26334d; }

    .dm-footer button {
      width: 42px; height: 42px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      border: none; cursor: pointer; transition: 0.2s;
    }

    #sendBtn { background: var(--accent-blue); color: white; width: auto; border-radius: 12px; padding: 0 20px; }
    #sendCoinBtn { background: var(--accent-gold); color: #000; }
    #sendBalanceBtn { background: var(--accent-green); color: #000; }

    /* Modal Styling */
    .modal-box {
      background: #1e293b; border: 1px solid #334155;
      padding: 40px; border-radius: 24px; width: 340px;
    }
    .modal-box input {
      width: 100%; box-sizing: border-box;
      background: #0f172a; border: 1px solid #334155;
      margin-bottom: 15px; padding: 14px; border-radius: 12px; color: white;
    }
    .modal-box button {
      background: var(--accent-blue); padding: 14px; border-radius: 12px;
      font-weight: 700; letter-spacing: 1px;
    }
</style>
</head>
<body>
  <!-- √úST BAR (Kullanƒ±cƒ± ve √ßƒ±kƒ±≈ü) -->
  <div class="topbar" id="topBar" style="display:none;">
    <div class="profile-area">
      <span class="profile-name" id="profileName"></span>
      <button class="logout-btn" id="logoutBtn">√áƒ±kƒ±≈ü Yap</button>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal-overlay" style="display:none;">
    <form class="modal-box" id="loginForm" autocomplete="off" onsubmit="return false;">
      <div class="modal-title">Giri≈ü Yap</div>
      <input id="loginUsername" placeholder="Kullanƒ±cƒ± Adƒ±" autocomplete="username" required />
      <input id="loginPassword" type="password" placeholder="≈ûifre" autocomplete="current-password" required />
      <button type="submit" id="loginBtn">Giri≈ü yap</button>
      <div class="err" id="loginError"></div>
    </form>
  </div>

  <div class="dm-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <span class="material-icons-round" style="font-size: 22px;color:#50a8ff;">people</span>
        Arkada≈ülar
      </div>
      <div class="users-list" id="usersList">
        <div style="color:#aaa; text-align:center; margin:16px 0;">Y√ºkleniyor...</div>
      </div>
    </aside>
    <main class="main-dm-area">
      <div class="dm-header" id="dmHeader">Ki≈üi se√ß</div>
      <div class="dm-messages" id="dmMessages">
        <div style="text-align:center; color:#b9b9ce; opacity:0.75; margin-top:90px;">Soldan bir arkada≈ü se√ßin.</div>
      </div>
      <div class="dm-footer">
        <input id="dmInput" type="text" placeholder="Mesaj yaz..." autocomplete="off" disabled />
        <button id="sendBtn" disabled>G√∂nder</button>
        <button id="sendCoinBtn" title="Coin G√∂nder" disabled>Coin</button>
        <button id="sendBalanceBtn" title="Bakiye G√∂nder" disabled>Bakiye</button>
      </div>
    </main>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // --- FIREBASE INIT ---
    const firebaseConfig = {
      apiKey: "AIzaSyBlirRiiNPpdqmTAmq6DsSq8mCUlgBHgVc",
      authDomain: "lilemir-new.firebaseapp.com",
      projectId: "lilemir-new",
      storageBucket: "lilemir-new.firebasestorage.app",
      messagingSenderId: "339863121380",
      appId: "1:339863121380:web:123195552e821b085e6bf1"
    };
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- LOGIN STATE ---
    let currentUser = null;
    let selectedUserId = null;
    let unsubDM = null;
    let usersCache = {};
    let onlineUsers = {};

    // --- DOM REFS ---
    const dmHeader = document.getElementById("dmHeader");
    const dmMessages = document.getElementById("dmMessages");
    const dmInput = document.getElementById("dmInput");
    const sendBtn = document.getElementById("sendBtn");
    const usersList = document.getElementById("usersList");
    const sendCoinBtn = document.getElementById('sendCoinBtn');
    const sendBalanceBtn = document.getElementById('sendBalanceBtn');
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const loginUsername = document.getElementById('loginUsername');
    const loginPassword = document.getElementById('loginPassword');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const topBar = document.getElementById('topBar');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileName = document.getElementById('profileName');

    // --- AUTH (username & password -- veritabanƒ±nda /users'dan) ---

    async function sha256Hex(str) {
      const enc = new TextEncoder();
      const data = enc.encode(str);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function signInByUsername(username, password) {
      loginError.textContent = '';
      if(!username || !password) { loginError.textContent = 'Kullanƒ±cƒ± adƒ± ve ≈üifre doldurulmalƒ±.'; return null; }
      try {
        const candidateFields = ['username','userName','user','displayName','email'];
        let doc = null;
        for(const f of candidateFields) {
          try {
            const q = await db.collection('users').where(f, '==', username).limit(1).get();
            if(!q.empty){ doc = q.docs[0]; break; }
          }catch(e){}
        }
        // fallback: dok√ºman id'si
        if(!doc) {
          const byId = await db.collection('users').doc(username).get();
          if(byId.exists) doc = byId;
        }
        // yeni kullanƒ±cƒ± otomatik olu≈ütur
        if(!doc) {
          const newRef = db.collection('users').doc();
          const hashed = await sha256Hex(password);
          const payload = {
            username, displayName: username,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            balance: 0, coins: 0,
            hashedPassword: hashed
          };
          await newRef.set(payload);
          const snap = await newRef.get();
          doc = snap;
        }
        const data = doc.data() || {};
        // ≈üifre kontrol√º
        const passCandidates = ['hashedPassword','passwordHash','passHash','pwdHash','password','pwHash','pass','hashed_password','hashed'];
        let stored = null;
        for(const pf of passCandidates)
          if(data[pf] !== undefined && data[pf] !== null) { stored = String(data[pf]).trim(); break; }
        if(!stored) { loginError.textContent = 'Bu kullanƒ±cƒ± i√ßin ≈üifre tanƒ±mlƒ± deƒüil'; return null; }
        const isHex64 = /^[a-f0-9]{64}$/i.test(stored);
        if(isHex64) {
          const provided = await sha256Hex(password);
          if(provided.toLowerCase() !== stored.toLowerCase()) {
            loginError.textContent = '≈ûifre yanlƒ±≈ü';
            return null;
          }
        } else {
          if(password !== stored) {
            loginError.textContent = '≈ûifre yanlƒ±≈ü';
            return null;
          }
        }
        // ba≈üarƒ±!
        currentUser = Object.assign({}, data, { uid: doc.id, username: doc.id });
        localStorage.setItem('oc_user', doc.id);
        updateProfileBar();
        loginModal.style.display = 'none';
        topBar.style.display = 'flex';
        loadFriendsAndUsers();
        setOnline(currentUser.uid, true);
        window.addEventListener('beforeunload', ()=> setOnline(currentUser.uid, false));
        return currentUser;
      } catch(err) {
        console.error('signIn error', err);
        loginError.textContent = 'Giri≈ü hatasƒ±';
        return null;
      }
    }

    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      await signInByUsername(loginUsername.value.trim(), loginPassword.value);
    });

    function showLogin() {
      loginModal.style.display = 'flex';
      loginForm.reset();
      loginError.textContent = '';
      loginUsername.focus();
      topBar.style.display = 'none';
    }

    function updateProfileBar() {
      if(currentUser) {
        profileName.textContent = currentUser.displayName || currentUser.username || currentUser.uid || "Kullanƒ±cƒ±";
        topBar.style.display = 'flex';
      }
    }

    async function tryAuth() {
      let userId = localStorage.getItem("oc_user");
      if (!userId) return showLogin();
      const doc = await db.collection("users").doc(userId).get();
      if (!doc.exists) { showLogin(); return; }
      currentUser = { uid: doc.id, ...(doc.data()||{}) };
      updateProfileBar();
      topBar.style.display = 'flex';
      loadFriendsAndUsers();
      setOnline(currentUser.uid,true);
      window.addEventListener('beforeunload', ()=> setOnline(currentUser.uid, false));
    }

    logoutBtn?.addEventListener('click', function(){
      localStorage.removeItem('oc_user');
      topBar.style.display = 'none';
      // disconnect presence if online
      if(currentUser && currentUser.uid) setOnline(currentUser.uid,false);
      currentUser = null;
      selectedUserId = null;
      dmHeader.textContent = "Ki≈üi se√ß";
      dmMessages.innerHTML = '<div style="text-align:center; color:#b9b9ce; opacity:0.75; margin-top:90px;">Soldan bir arkada≈ü se√ßin.</div>';
      dmInput.disabled = sendBtn.disabled = sendCoinBtn.disabled = sendBalanceBtn.disabled = true;
      // show login modal
      showLogin();
    });

    async function setOnline(uid, val){
      try { await db.collection('users').doc(uid).update({ online: !!val, lastActive: new Date().toISOString() }); }
      catch(e){}
    }

    async function loadFriendsAndUsers(){
      usersList.innerHTML = '<div style="color:#aaa;text-align:center;">Y√ºkleniyor...</div>';
      db.collection("users").onSnapshot(snapshot=>{ 
        let html = '';
        onlineUsers = {};
        usersCache = {};
        snapshot.forEach(doc=>{
          const u = doc.data();
          usersCache[doc.id] = u;
          if(u.online) onlineUsers[doc.id]=true;
        });
        snapshot.forEach(doc=>{
          if(currentUser && doc.id===currentUser.uid) return;
          const u = doc.data();
          html += `
            <div class="user-item" data-uid="${doc.id}">
              <span class="user-status ${u.online ? 'online' : 'offline'}"></span>
              <span class="user-name">${(u.displayName||u.username||doc.id)}</span>
              <span class="user-new-msg" id="umsg_${doc.id}" style="display:none;">‚óè</span>
            </div>
          `;
        });
        usersList.innerHTML = html || '<div style="text-align:center; color:#888; margin-top:24px;">Kullanƒ±cƒ± yok.</div>';
        Array.from(document.querySelectorAll('.user-item')).forEach(el=>{
          el.onclick = ()=>selectUserForDM(el.dataset.uid);
        });
        watchNewDms();
      });
    }

    function selectUserForDM(uid){
      if(!uid) return;
      if(selectedUserId===uid) return;
      selectedUserId=uid;
      if(unsubDM) { unsubDM(); unsubDM=null; }
      Array.from(document.querySelectorAll('.user-item')).forEach(el=>el.classList.toggle('active',el.dataset.uid===uid));
      const user = usersCache[uid]||{};
      dmHeader.textContent = user.displayName||user.username||uid;
      dmInput.disabled = sendBtn.disabled = sendCoinBtn.disabled = sendBalanceBtn.disabled = false;
      dmInput.value='';
      loadMessages(uid);
      document.getElementById('umsg_'+uid)?.setAttribute('style','display:none');
    }

    function scrollToBottom(){
      setTimeout(()=>{ dmMessages.scrollTop = dmMessages.scrollHeight+200 }, 80);
    }

    function loadMessages(uid){
      if(unsubDM)unsubDM();
      const myid = currentUser.uid;
      const otherid = uid;
      const pairId = [myid,otherid].sort().join("_");
      unsubDM = db.collection("dms").doc(pairId).collection("messages")
        .orderBy("createdAt","asc").onSnapshot(snapshot=>{
        dmMessages.innerHTML = '';
        if(snapshot.empty){
          dmMessages.innerHTML = '<div style="text-align:center; color: #999; margin-top:70px;">Sohbet yok, bir mesaj yazƒ±n</div>';
          return;
        }
        snapshot.forEach(doc=>{
          const msg = doc.data();
          const div = document.createElement("div");
          div.className = "dm-msg"+(msg.sender===myid?' me':'');
          div.innerHTML = escapeHtml(msg.text||'');
          const meta = [];
          if(msg.createdAt?.toDate) meta.push(msg.createdAt.toDate().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}));
          div.innerHTML += `<div class="meta">${(msg.sender===myid?'Siz':'O')} ${meta.join(" ‚Ä¢ ")}</div>`;
          dmMessages.appendChild(div);
        });
        scrollToBottom();
      });
    }

    dmInput.addEventListener('keydown',e=>{
      if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendDM(); }
    });
    sendBtn.addEventListener('click',sendDM);

    function sendDM(){
      const txt = dmInput.value.trim();
      if(!txt || !selectedUserId) return;
      const myid = currentUser.uid;
      const otherid = selectedUserId;
      const pairId = [myid,otherid].sort().join("_");
      db.collection("dms").doc(pairId).collection("messages").add({
        text: txt,
        sender: myid,
        receiver: otherid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(()=>{
        dmInput.value='';
      });
      db.collection("dms").doc(pairId).set({
        lastMsg:txt, lastSender:myid, lastReceiver:otherid,
        lastAt:firebase.firestore.FieldValue.serverTimestamp()
      },{merge:true});
    }

    // COIN G√ñNDER
    sendCoinBtn.addEventListener('click', async function(){
      if(!selectedUserId) return;
      let amountTxt = prompt("Ka√ß coin g√∂ndermek istiyorsun? (Pozitif sayƒ±, min 1)");
      let amount = Number(amountTxt);
      if(!amount || amount<=0) return alert("Ge√ßersiz miktar");
      const fromRef = db.collection("users").doc(currentUser.uid);
      const toRef = db.collection("users").doc(selectedUserId);
      try{
        await db.runTransaction(async (tx)=>{
          const fromSnap = await tx.get(fromRef);
          const toSnap = await tx.get(toRef);
          if(!fromSnap.exists || !toSnap.exists) throw new Error("Kullanƒ±cƒ± yok.");
          let myCoins = fromSnap.data().coins || 0;
          let toCoins = toSnap.data().coins || 0;
          if(myCoins < amount) throw new Error("Yeterli coinin yok!");
          tx.update(fromRef, { coins: myCoins - amount });
          tx.update(toRef, { coins: toCoins + amount });
        });
        const myid = currentUser.uid, otherid = selectedUserId, pairId=[myid,otherid].sort().join("_");
        db.collection("dms").doc(pairId).collection("messages").add({
          text: `üí∞ ${amount} coin g√∂nderdiniz!`,
          sender: myid, receiver: otherid, system:true, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Coinler g√∂nderildi!");
      }catch(e){ alert("Hata: "+e.message); }
    });

    // BAKƒ∞YE G√ñNDER
    sendBalanceBtn.addEventListener('click', async function(){
      if(!selectedUserId) return;
      let amountTxt = prompt("Ne kadar bakiye g√∂ndermek istiyorsun? (Pozitif sayƒ±, min 1)");
      let amount = Number(amountTxt);
      if(!amount || amount<=0) return alert("Ge√ßersiz miktar");
      const fromRef = db.collection("users").doc(currentUser.uid);
      const toRef = db.collection("users").doc(selectedUserId);
      try{
        await db.runTransaction(async (tx)=>{
          const fromSnap = await tx.get(fromRef);
          const toSnap = await tx.get(toRef);
          if(!fromSnap.exists || !toSnap.exists) throw new Error("Kullanƒ±cƒ± yok.");
          let myBal = fromSnap.data().balance ?? fromSnap.data().money ?? 0;
          let toBal = toSnap.data().balance ?? toSnap.data().money ?? 0;
          if(myBal < amount) throw new Error("Yeterli bakiyen yok!");
          if('balance' in fromSnap.data()) tx.update(fromRef, { balance: myBal - amount });
          else tx.update(fromRef, { money: myBal - amount });
          if('balance' in toSnap.data()) tx.update(toRef, { balance: toBal + amount });
          else tx.update(toRef, { money: toBal + amount });
        });
        const myid = currentUser.uid, otherid = selectedUserId, pairId=[myid,otherid].sort().join("_");
        db.collection("dms").doc(pairId).collection("messages").add({
          text: `üíµ $${amount} bakiye g√∂nderdiniz!`,
          sender: myid, receiver: otherid, system:true, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Bakiye g√∂nderildi!");
      }catch(e){ alert("Hata: "+e.message); }
    });

    function escapeHtml(s) { return (s||'').replace(/[&<"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]); }

    function watchNewDms(){
      if(!currentUser) return;
      const myid = currentUser.uid;
      db.collection("dms")
        .where("lastReceiver","==",myid)
        .onSnapshot(snapshot=>{
          snapshot.forEach(doc=>{
            const pair = doc.id;
            const data = doc.data()||{};
            if(pair.includes(myid) && data.lastSender!==myid && data.lastMsg && data.lastAt?.toDate){
              if(Notification.permission==="granted"){
                new Notification(`${usersCache[data.lastSender]?.displayName||'Biri'} size mesaj g√∂nderdi`,{
                  body:data.lastMsg
                });
              }
              let notifList = JSON.parse(localStorage.getItem("dmNotifs")||"{}");
              notifList[data.lastSender]=true;
              localStorage.setItem("dmNotifs",JSON.stringify(notifList));
              const badgeEl = document.getElementById('umsg_'+data.lastSender);
              if(badgeEl) badgeEl.style.display='';
            }
          });
        });
    }
    function clearMsgBadgeFor(uid){
      let notifList = JSON.parse(localStorage.getItem("dmNotifs")||"{}");
      if(uid && notifList[uid]){ delete notifList[uid]; localStorage.setItem("dmNotifs",JSON.stringify(notifList)); }
      const badgeEl = document.getElementById('umsg_'+uid);
      if(badgeEl) badgeEl.style.display='none';
    }
    tryAuth();
  </script>
</body>
</html>